ARG  R_VERSION=4.4.0
FROM ghcr.io/rocker-org/tidyverse:${R_VERSION}

# System libs
RUN apt-get update \
  && apt-get install -y libglpk40 \
    libxt6 \
    texlive-latex-base \
    texlive-fonts-recommended \
    texlive-fonts-extra \
    texlive-latex-extra \
  && rm -rf /var/lib/apt/lists/*

# R packages
RUN install2.r --error \
  --deps TRUE \
  --skipinstalled \
  devtools \
  rcmdcheck \
  lintr \
  lme4 \
  bspm \
  && rm -rf /tmp/downloaded_packages

# use .Rprofile to select Posit Public PM snapshot
# - for R versions earlier than 4.3 we update to a snapshot from 2023-12-01 because of arrow 14.0.0 that is required
ARG r_profile=.Rprofile
RUN if [ "$R_VERSION" = "4.2.3" ]; then \
      # For R 4.2.3 snapshot from 2023-11-17
      echo "Setting up snapshot for R 4.2.3 on 2023-11-17"; \
      echo "options(repos = c(" > "$r_profile"; \
      echo "  CRAN = \"https://packagemanager.posit.co/cran/__linux__/jammy/2023-11-17\"" >> "$r_profile"; \
      echo "))" >> "$r_profile"; \
    else \
      # For R 4.1.3
      if [ "$R_VERSION" = "4.1.3" ]; then \
        echo "Setting up snapshot for R 4.1.3"; \
        echo "options(repos = c(" > "$r_profile"; \
        echo "  CRAN = \"https://packagemanager.posit.co/cran/__linux__/focal/2023-11-17\"" >> "$r_profile"; \
        echo "))" >> "$r_profile"; \
      else \
        echo "Running on R > 4.2.3. Nothing to update!"; \
      fi \
    fi

ENV _R_CHECK_FORCE_SUGGESTS_=FALSE

COPY OlinkAnalyze/DESCRIPTION /src/DESCRIPTION

RUN R -e "devtools::install_dev_deps(pkg = '/src', dependencies = TRUE)"

ENTRYPOINT ["R", "--vanilla"]
