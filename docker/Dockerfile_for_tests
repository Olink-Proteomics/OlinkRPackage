ARG  R_VERSION=4.4.0
FROM ghcr.io/rocker-org/tidyverse:${R_VERSION}

# System libs
RUN apt-get update \
  && apt-get install -y libglpk40 \
    libxt6 \
    texlive-latex-base \
    texlive-fonts-recommended \
    texlive-fonts-extra \
    texlive-latex-extra \
  && rm -rf /var/lib/apt/lists/*

ARG r_profile=.Rprofile
RUN if [ "$R_VERSION" = "4.2.3" ]; then \
      echo "Setting up repos for R 4.2.3 on 2023-11-30"; \
      echo "options(repos = c(" > "$r_profile"; \
      echo "  binary = \"https://p3m.dev/cran/__linux__/jammy/2023-11-30\"," >> "$r_profile";
      echo "  source = \"https://p3m.dev/cran/__linux__/2023-11-30\"," >> "$r_profile"; \
      echo "  CRAN = \"https://cloud.r-project.org\"" >> "$r_profile"; \
      echo "))" >> "$r_profile"; \
    else \
      echo "Argument not provided"; \
    fi

# R packages
RUN install2.r --error \
  --deps TRUE \
  --skipinstalled \
  devtools \
  rcmdcheck \
  lintr \
  lme4 \
  bspm \
  && rm -rf /tmp/downloaded_packages

# RUN R -e "install.packages('arrow', dependencies = TRUE)"

ENV _R_CHECK_FORCE_SUGGESTS_=FALSE

COPY OlinkAnalyze/DESCRIPTION /src/DESCRIPTION

RUN R -e "devtools::install_dev_deps(pkg = '/src', dependencies = TRUE)"

ENTRYPOINT ["R", "--vanilla"]
