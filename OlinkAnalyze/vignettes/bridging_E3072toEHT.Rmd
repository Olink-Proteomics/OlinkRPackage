---
title: "Bridging Olink^®^ Explore 3072 to Olink^®^ Explore HT"
output: 
  html_vignette:
    toc: true
    toc_depth: 3
    includes:
      in_header: ../man/figures/logo.html
vignette: >
  %\VignetteIndexEntry{Bridging Olink^®^ Explore 3072 to Olink^®^ Explore HT}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy = FALSE,
  tidy.opts = list(width.cutoff = 95),
  fig.width = 6,
  fig.height = 3,
  message = FALSE,
  warning = FALSE,
  time_it = TRUE,
  eval = FALSE,
  fig.align = "center"
)
```

```{r, echo=FALSE}
library(OlinkAnalyze)
library(dplyr)
library(stringr)
library(ggplot2)
library(kableExtra)
```

## Introduction

Individual Olink^®^ NPX^TM^ data sets are generally normalized using
either plate control normalization or intensity normalization methods.
Since NPX is a relative measurement, in the case when a study is
separated into multiple batches, an additional normalization step is
needed to allow the data to be comparable. The following tutorial is
designed to give you an overview of the Olink bridging procedure for
combining data sets from Olink^®^ Explore 3072 and Olink^®^ Explore HT
products.

### Important Terminology

-   **Within-product bridging** – Normalization of two or more studies
    run on the same Olink product using overlapping samples

-   **Between-product bridging** - Normalization of two or more studies
    from different Olink products (in this case, Olink Explore 3072 and
    Olink Explore HT) using overlapping samples

-   **Batch** – Studies run at the same time, fully randomized, and
    using the same set of reagents are known as a batch. Studies that
    are not randomized or are run at different times or using different
    reagents require additional normalization.

-   **Batch effect/correction** – As NPX is a relative quantification,
    overall NPX values may shift between batches. This can result in
    separation of batches which can be corrected for using normalization
    or accounted for within a statistical model

-   **Bridge samples** – Overlapping samples run on two or more batches
    that are used as references to facilitate normalization

### Within- and between-product bridging

The joint analysis of two or more NPX data sets run on the same Olink
product often requires an additional batch correction step to remove
technical variation, which is referred to as overlapping sample
reference normalization, bridge normalization, or just simply bridging.
For more information on within-product bridging, see the [Introduction
to Bridging
tutorial](https://cran.r-project.org/web/packages/OlinkAnalyze/vignettes/bridging_introduction.html).
Bridge normalization makes certain assumptions on the distributions of
the assays, namely that we are measuring the same true biological range
no matter the setting. If an assay displays different distributions
between bridging samples, then both bridging and downstream statistical
analysis will be affected. Within a product we assume the variance and
shape of the distribution remains constant within assays.

Between products, assays may vary more and fewer assumptions can be made
regarding the similarity of assay distributions and variance. Olink
Explore 3072 and Olink Explore HT are both products that use PEA
technology combined with next generation sequencing to calculate NPX for
thousands of proteins. Since many of the assays profiled in Olink
Explore 3072 are also found on Olink Explore HT, bridging data across
products enables increased power in studies consisting of both Explore
3072 and Explore HT data sets, rather than limiting these studies to
meta-analysis. However, the number of assays measured and antibodies and
reagents used differ between the two products, leading to signal in one
product and noise in another product. Bridging signal to noise can have
detrimental effects on downstream statistical analysis. This means that
while some assays will be able to be bridged using the same method as in
within-product bridging, others will require a different normalization
method, and some will not be bridgeable at all.

In the case where a study consists of separate batches run on Olink
Explore 3072 and Olink Explore HT, an additional batch correction step
is required to allow data from these two products to be analyzed
together, which is referred to as between-product bridging, or Olink
Explore 3072 to Olink Explore HT bridging. This normalization strategy
combines median-centering (as is used in within product bridging) and
quantile smoothing to normalize assays across products based on the
assumption that assays can be bridged provided they have signal in both
products or noise in both products.

### Considerations for between-product bridging

Product bridging allows the NPX values of an Olink Explore 3072 project
to be normalized and made comparable to the NPX values of an Olink
Explore HT project. This process is one-directional, and normalizing
Olink Explore HT NPX values to Olink Explore 3072 is not supported.

The product bridging normalization uses the **\~**2900 assays that are
overlapping between Olink Explore 3072 and Olink Explore HT. Each
overlapping assay undergoes a series of checks that evaluate the number
of counts, correlation, and difference of NPX ranges between the two
data sets. If an assay has enough counts and comparable metrics between
the two data sets, it is determined to be suitable for bridging
(referred to as a "bridgeable assay"). The set of bridgeable assays
across products will vary from data set to data set, based on the
samples present within the studies. Depending on the NPX distribution of
each bridgeable assay in the two data sets, the assay is normalized
using either median normalization or quantile smoothing.

Product bridging between an Explore 3072 and an Explore HT NPX data set
requires **40-60 bridging samples**. Bridging samples are shared samples
among data sets - that is that samples that are analyzed in both data
sets. Olink® NPX data sets without shared samples should not be combined
using the bridging approach described below. More information on bridge
sample selection can be found in the [selecting bridging samples
section](https://cran.r-project.org/web/packages/OlinkAnalyze/vignettes/bridging_introduction.html#selecting-bridging-samples)
of the Introduction to Bridging tutorial.

## Bridge Sample Selection

Prior to running the second study, bridging samples must be selected
from the first study and be run on the second study. These samples can
be selected using the `olink_bridgeselector()` function in Olink Analyze
as detailed in [the Introduction to bridging
tutorial](https://cran.r-project.org/web/packages/OlinkAnalyze/vignettes/bridging_introduction.html#selecting-bridging-samples).
LOD can also be calculated from fixed LOD or negative controls as
detailed in the [Calculating LOD from Olink Explore data
tutorial](https://cran.r-project.org/web/packages/OlinkAnalyze/vignettes/LOD.html).

## Workflow Overview

Olink Explore 3072 to Olink Explore HT bridging requires Explore 3072
data and Explore HT data which has at least **40 to 60** overlapping
bridge samples. For studies containing multiple batches of Explore 3072
data, the Explore 3072 data sets should be bridged using within-product
bridging as detailed in the [Introduction to bridging
tutorial](https://cran.r-project.org/web/packages/OlinkAnalyze/vignettes/bridging_introduction.html)
prior to performing between-product bridging.

The assays from Explore 3072 are matched to the corresponding assays in
Explore HT and evaluated to determine if the assay is bridgeable. In
parallel, the assays are normalized using quantile smoothing and
normalization using the median of paired differences. The result is an
adjusted Explore 3072 data set with three additional columns:

-   `BridgingRecommendation`: a flag which indicates if the assay is
    bridgeable and, if so, which normalization method is recommended

-   `MedianCenteredNPX`: NPX values after normalization using the median
    of paired differences

-   `QSNormalizedNPX`: NPX values after normalization using quantile
    smoothing

A visual representation of the workflow is shown below.

```{r, fig.cap= fcap, eval = TRUE, echo = FALSE, out.width="100%"}
knitr::include_graphics(normalizePath("../man/figures/Bridging_schematic.png"), error = FALSE)
fcap <- "Schematic of Explore 3072 to Explore HT Bridging Workflow"
```

Note that regardless of the bridging recommendation, NPX values will be
available for both normalization methods.

## Import NPX files

To normalize Explore 3072 data to Explore HT data, first the two data
sets are read into R using `read_NPX()`. If more than two data sets are
being normalized, all Explore 3072 studies should be normalized together
prior to normalizing between products and the concatenated bridged data
set should be used as the input. In the case of multiple Explore HT
studies, only one Explore HT study should be chosen as the reference
data set. The data can be loaded using `read_NPX()` function with
default Olink Software NPX file as input, as shown below.

```{r message=FALSE, eval=FALSE, echo = TRUE}
data_E3072 <- read_NPX("~/NPX_Explore3072_location.parquet") # Could also be a CSV file
data_EHT <- read_NPX("~/NPX_ExploreHT_location.parquet")
```

## Checking input datasets and bridging samples

First, confirm that there are overlapping sample IDs within the study.
In the case of non-overlapping sample IDs, the `overlap_sample_list`
will contain 2 arrays of equal length where the index of each entry
corresponds to the same sample. For example, if a sample had the
SampleID of `Sample_1_Aliquot_1` in the first batch and
`Sample_1_Aliquot_2` in the second batch, then the overlap sample list
should look as the following.

```{r, echo = FALSE}
overlap_sample_list <-list("DF1" = c("A1", "A2", "A3", "Sample_1_Aliquot_1"),
                           "DF2" = c("A1", "A2", "A3",  "Sample_1_Aliquot_2")) 
```

Note that external controls should not be included in the list of
bridging samples, as detailed in the [Bridge Sample Selection] section
of this tutorial. External control samples often share the same naming
convention across data sets but may represent different samples due to
reagent batch differences. Appending the project name to the end of the
control samples can ensure unique Sample IDs.

```{r, echo = TRUE, eval=FALSE}
data.frame(SampleID = intersect(data_E3072$SampleID, data_EHT$SampleID)) %>%
  dplyr::filter(!stringr::str_detect(SampleID, "CONTROL_SAMPLE"))
```

```{r, echo=FALSE, eval=FALSE}
data.frame(SampleID = intersect(data_E3072$SampleID, data_EHT$SampleID)) %>%
  dplyr::filter(!stringr::str_detect(SampleID, "CONTROL_SAMPLE")) %>% #Remove control samples
  kableExtra::kbl(booktabs = TRUE,
      digits = 2,
      caption = "Table 3. Overlapping Bridge Samples") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE,
                position = "center", latex_options = "HOLD_position")
```

```{r pca1, message=FALSE, fig.cap=f3, eval=FALSE}
#### Extract bridging samples

overlapping_samples <-  data.frame(SampleID = intersect(data_E3072$SampleID, data_EHT$SampleID)) %>%  
  filter(!str_detect(SampleID, "CONTROL_SAMPLE")) %>% #Remove control samples
  pull(SampleID)

npx_before_br <- data_E3072 %>%
  dplyr::filter(!str_detect(SampleID, "CONTROL_SAMPLE")) %>% #Remove control samples
  dplyr::mutate(Type = if_else(SampleID %in% overlapping_samples,
                        paste0("Explore 3072 Bridge"),
                        paste0("Explore 3072 Sample"))) %>%
  rbind({
    data_EHT %>%
      filter(!str_detect(SampleID, "CONTROL_SAMPLE")) %>% #Remove control samples %>% 
      mutate(Type = if_else(SampleID %in% overlapping_samples,
                            paste0("Explore HT Bridge"),
                            paste0("Explore HT Sample"))) %>%
      mutate(SampleID = if_else(SampleID %in% overlapping_samples,
                                paste0(SampleID, "_new"),
                                SampleID))
  })

### PCA plot
OlinkAnalyze::olink_pca_plot(df          = npx_before_br,
                             color_g     = "Type")
```

## Normalization

The `olink_normalization_bridge_product()` function is used to determine
which assays are bridgeable and to bridge across products as described
in the Workflow Overview and in the sections below. Within this function
the bridging recommendations for each assay are determined and the NPX
values are normalized using the two methods described below.

```{r, eval=FALSE}
# Find shared samples
npx_1 <- data_EHT %>%
  mutate(Project = "data1") 
npx_2 <- data_E3072 %>%
  mutate(Project = "data2")

overlap_samples <-data.frame(SampleID = intersect(npx_1$SampleID, npx_2$SampleID)) %>%
  filter(!str_detect(SampleID, "CONTROL_SAMPLE")) %>% #Remove control samples
  pull(SampleID)

overlap_samples_list <- list("DF1" = overlap_samples,
                             "DF2" = overlap_samples)
npx_br_data <- olink_normalization_bridge_product(npx_1, 
                                   npx_2,
                                   bridge_samples = overlap_samples_list,
                                   exploreht_name = "reference",
                                   explore3072_name = "new")
```

### Determining bridging recommendations

For an assay to be bridgeable across products it must either have signal
in both products or be primarily background signal in both products.
Bridging noise into signal or signal into noise can negatively impact
downstream statistical analysis. To determine if an assay is bridgeable,
the following criteria are considered:

-   Is there a linear relationship between products?
    -   **Assessing linearity across products:** To determine if there
        is a linear relationship between products for an assay, the
        linear coefficient of determination (R^2^) is calculated using
        Pearson correlation. R^2^ is a measure of how much of the
        variation in the data is explained by the linear function
        compared to just using the mean.In this correlation, counts
        below 10 are excluded due to lack of signal. The R^2^ value is
        calculated and an assay is considered to have a linear
        relationship across products if the R^2^ value is above the
        cutoff. A higher R^2^ value indicates, that for both products,
        the assay is in the linear range. Conversely, a low R2 means
        that either one or both assays are in background. The default
        cutoff is set to R^2^ \> 0.8 indicating that at least 80% of the
        variation in the data is explained by the linear function.
-   Are the NPX ranges in the two products similar?
    -   **Assessing similarity of NPX ranges:** To determine if the NPX
        ranges are similar across products, the difference in NPX values
        from the 10% to 90% quantile is calculated for each product,
        excluding data points with counts less than 10. If the
        difference in range of NPX between products is greater than the
        cutoff than the ranges are not considered similar across
        products. Since the NPX values are calculated on the same
        samples, it is expected that an increase in 1 NPX in one product
        would correspond to an increase of 1 NPX in the other product.
        If the ranges are not similar, this suggests that 1 NPX is not
        equivalent across products. By default, the cutoff is set to a
        difference of less than 1 NPX between products.
-   Are there sufficient counts in the Explore HT data?
    -   **Assessing if there are sufficient counts:** An assay's
        absolute level of counts is important to consider as the
        instruments used to generate NPX values have an inherent noise
        level. To determine if there are sufficient counts in an assay
        for bridging, the median number of counts from Explore HT is
        calculated, excluding data points with less than 10 counts. If
        the median number of counts is less than the cutoff than the
        assay does not have sufficient counts to be used for bridging.
        The default cutoff is set to 150 counts, which is based on the
        count quality control metrics for Explore products.

For assays that are bridgeable, the shape of the NPX distribution is
compared between the two products:

-   **Assessing similarity of NPX distribution across products:** If the
    three criteria outlined above are met then the assay is considered
    bridgeable. Otherwise, bridging is not recommended for that assay.
    If an assay is bridgeable, the similarity of the NPX distribution is
    used to determine which method is recommended for bridging. The
    Kolmogorov-Smirnov test, or KS test, is used to assess the
    similarity of two distributions by calculating the KS statistic,
    which is based on the empirical cumulative distribution function
    (ECDF). Counts below 10 are excluded and the largest difference seen
    in the ECDF becomes the KS statistic. If the KS statistic is above
    the cutoff the distributions are considered to have different
    shapes. In this case, a median shift is not sufficient to normalized
    the data and quantile smoothing is recommended. If the distance is
    less than the cutoff then normalization using the median of paired
    differences is recommended. By default this cutoff difference is set
    to 0.2.

An overview of these criteria is visualized below.

```{r, fig.cap= fcap, eval = TRUE, echo = FALSE, out.width="100%"}
knitr::include_graphics(normalizePath("../man/figures/assay_bridgeability.png"), error = FALSE)
fcap <- "Criteria to determine the bridging recommendation for an assay"
```

Prior to assessment, outlier bridge samples are excluded. A sample is
considered an outlier if the NPX value is more than 3 times the
interquartile range above or below the median on either product.

After assessment, an assay is considered bridgeable if it meets the
first three criteria. The fourth criteria determines which normalization
method is recommended for bridging. If all four criteria are met then
the recommended method is normalization using the median of paired
differences. If only the first three criteria are met then quantile
smoothing is recommended. If any of the first three criteria are not met
then bridging is not recommended for that assay. Note that bridgeable
assays will differ between projects based on the expression of bridge
samples in the studies.

### Normalization using the median of paired differences

If it is expected that both the kind of distribution and the variance
per test between runs are the same, then normalization using the median
of paired differences will be preferred. Normalization using the median
of paired differences based on the bridge samples is performed in the
following steps:

1.  For each assay in the Explore 3072 project, calculate the pairwise
    difference for each of the overlapping samples with the Explore HT
    project.

2.  Estimate the normalization factor of each assay by finding the
    median of the pairwise differences.

3.  Use the assay-specific normalization factor for each assay to
    normalize each data point from Explore 3072 to Explore HT.

### Quantile smoothing

Since Explore HT and Explore 3072 are two distinct products and the
assays differ considerably between products, some of the assays exist in
corresponding but distinct NPX spaces. For those assays, the median of
paired differences is insufficient for bridging as it only considers one
anchor point (the median/50% quantile). Instead, quantile smoothing (QS)
using multiple anchor points (5%, 10%, 25%, 50%, 75%, 90% and 95%
quantiles) is favored to map the Explore 3072 data to the Explore HT
distribution. The normalization using QS uses bridge samples to perform
the following steps:

1.  Each data point of the samples from Explore 3072 is mapped to the
    equivalent space in Explore HT using an empirical cumulative
    distribution function. An empirical cumulative distribution function
    is a probability model which uses the observed data, in this case
    the NPX values of the bridge samples for an assay, to create a step
    function which interpolates linearly between the available data
    points.

2.  The empirical distribution function is used to map the data points
    from Explore 3072 to the Explore HT space using the specified
    quantiles. At this point all data points from the bridge samples
    have NPX values that are normalized to the data points in Explore
    HT.

3.  To normalize the remaining data a spline regression model is
    constructed using the sorted Explore 3072 data and the mapped
    Explore 3072 data along with the anchor points of the spline
    function. A spline regression model divides a data set at the
    quantiles and uses the quantile as an anchor point or knot. Then a
    model is generated to fit the points between each anchor point.

4.  The spline regression model is then used to predict all the data
    points from Explore 3072 to Explore HT. The spline regression model
    results in a combination of linear regression models within
    intervals. The Explore 3072 NPX values are input as the x value
    within the corresponding interval, which results in a y value
    equivalent to the Explore HT NPX value.

### Function Output

The output from `olink_normalization_bridge_product()` function is a
dataframe with concatenated data from the two products and additional
columns including adjusted NPX values, bridging recommendations, mapping
information, and project names. The adjusted NPX values are notated in
the columns `MedianAdjustedNPX` and `QSNormalizedNPX`. For each assay a
recommendation is listed in the `BridgingRecommendation` column and
lists what method, if any should be used for that assay. Additional
columns including `OlinkID_HT` and `OlinkID_3072` map the assays across
products and the `Project` column lists the name of the project based on
the `exploreht_name` and `explore3072_name` arguments. The resulting
data set will contain the Explore HT data set, which will be identical
to the input reference data and the newly bridged Explore 3072 data set.

```{r, post_bridging_3k_data , echo=FALSE, eval=FALSE}
npx_br_data %>% 
  head(10) %>% 
  kableExtra::kbl(booktabs = TRUE,
      digits = 1,
      caption = "Table 4. First 10 rows of combined datasets after bridging.") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE, font_size = 10, 
                position = "center", latex_options = "HOLD_position") %>% 
  kableExtra::scroll_box(width = "100%")
```

## Evaluating the quality of bridging

PCA is used to assess the quality of bridging by determining if the
sample controls (SCs) and bridging samples appear closer after bridging.
Two PCAs can be generated, one containing the SCs and one containing the
bridging samples. Prior to bridging there will be a noticeable
separation between products which should decrease after bridging.

```{r pca2, message=FALSE, fig.cap= f8, eval=FALSE}
## After bridging

### Keep the data following BridgingRecommendation
npx_after_br_reco <- npx_br_data %>%
  filter(BridgingRecommendation != "Not Bridgeable") %>%
  mutate(NPX = case_when(
    BridgingRecommendation == "MedianCenteredNPX" ~ MedianCenteredNPX,
    BridgingRecommendation == "QSNormalizedNPX" ~ QSNormalizedNPX,
    .default = NPX)) %>%
  filter(!stringr::str_detect(Assay, "Inc|Amp|Ext"))

### Generate unique SampleIDs
npx_after_br_final <- npx_after_br_reco %>%
  dplyr::mutate(Type = ifelse(SampleID %in% overlapping_samples, 
                              paste(Project, "Bridge"),
                              paste(Project, "Sample"))) %>%
  dplyr:::mutate(SampleID = paste0(Project, PlateID, SampleID))
  
### PCA plot of the data from SCs
  npx_after_br_final |> filter(stringr::str_detect(SampleID, "CONTROL_SAMPLE")) |> 
    OlinkAnalyze::olink_pca_plot(color_g     = "Type")
  
### PCA plot of the data from bridging samples
  npx_after_br_final |> filter(stringr::str_detect(Type, "Bridge")) |> 
    OlinkAnalyze::olink_pca_plot(color_g     = "Type")
```

## Exporting Normalized Data

The normalized Explore 3072 data can be exported using
`arrow::write_parquet()` to create a long format Olink Explore file.

```{r, eval=FALSE}
df <- npx_br_data |>
    dplyr::filter(Project == "Explore_3072_NAME") |>
    arrow::as_arrow_table()

df$metadata$FileVersion <- "NA"
df$metadata$ExploreVersion <- "NA"
df$metadata$ProjectName <- "NA"
df$metadata$SampleMatrix <- "NA"
df$metadata$DataFileType <- "Olink Analyze Export File"
df$metadata$ProductType <- "Explore3072"
df$metadata$Product <- "Explore3072"
arrow::write_parquet(x = df, sink = "path_to_output.parquet")
```

## FAQs

### Overlapping Assays within products

Both the Explore 3072 and Explore HT products contain assays that appear
multiple times in the product, known as overlapping assays or
correlation assays. In Explore 3072, these present as overlapping assays
across panels. In Explore HT, these are overlapping assays across
blocks. These assays are included for QC purposes and allow users to
evaluate data performance across panels in Explore 3072 and across
blocks in Explore HT.

Within each product, the assays contain unique OlinkID values for each
of their corresponding panels and blocks in Explore 3072 and Explore HT,
respectively. It should be noted that the overlapping assays themselves
differ between each product and that these assays differ from the
overlapping assays *across* products. For more information on
overlapping assays, you can access the [Olink FAQ
page](https://olink.com/knowledge/faq) and search overlapping assays.

Explore 3072 to Explore HT bridging generates and returns adjusted
values for all data points corresponding to each of the Explore 3072
correlation assays. In other words, each instance of an overlapping
assay will contain an adjusted value in its respective Explore 3072
panel. In the case of data with Explore HT correlation assays, Explore
3072 assays are only bridged to the Block 5 (least diluted) version of
the assay.

### Downstream Analysis

## Contact Us

We are always happy to help. Email us with any questions:

-   biostat\@olink.com for statistical services and general stats
    questions

-   support\@olink.com for Olink lab product and technical support

-   info\@olink.com for more information

## Legal Disclaimer

© 2024 Olink Proteomics AB.

Olink products and services are For Research Use Only and not for Use in
Diagnostic Procedures.

All information in this document is subject to change without notice.
This document is not intended to convey any warranties, representations
and/or recommendations of any kind, unless such warranties,
representations and/or recommendations are explicitly stated.

Olink assumes no liability arising from a prospective reader’s actions
based on this document.

OLINK, NPX, PEA, PROXIMITY EXTENSION, INSIGHT and the Olink logotype are
trademarks registered, or pending registration, by Olink Proteomics AB.
All third-party trademarks are the property of their respective owners.

Olink products and assay methods are covered by several patents and
patent applications <https://olink.com/legal/patents>.
