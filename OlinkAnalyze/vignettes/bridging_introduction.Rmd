---
title: "Introduction to bridging Olink®NPX datasets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to bridging datasets}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 95),
  fig.width = 10,
  message = FALSE,
  warning = FALSE,
  time_it = TRUE,
  fig.width = 7
)
```


Olink® NPX datasets are normalized datasets using either plate control
normalization or intensity normalization methods. Intensity
normalization method assumes that all samples within a project are fully
randomized.

The joint analysis of two or more Olink® NPX datasets often requires an 
additional batch correction step to remove technical variations, which
is referred to as bridging.

Bridging is needed if Olink® NPX datasets are:

-   plate control normalized only and run conditions (e.g lab and
reagent lots) have changes.

-   intensity normalized but from two different sample populations.

To bridge two or more Olink® NPX datasets, bridging samples are needed
to calculate adjustment factors between datasets. Bridging samples are 
shared samples among datasets. The recommended number
of bridge samples for Explore 1536 datasets is between 8-16. Olink® 
NPX datasets without overlapping samples should not be combined to perform 
joint analysis using the bridging approach described below.

The following tutorial is designed to provide an overview of the types 
of methods that are applicable using the Olink® bridging procedure.

## Setup bridging datasets

```{r setup}
library(magrittr)
```

Bridging datasets are standard Olink® NPX tables. They can be loaded using 
`read_NPX()` function with NPX manager output file as input.

```{r message=FALSE, eval=FALSE, echo = TRUE}
data1 <- OlinkAnalyze::read_NPX("~/NPX_file1_location.xlsx")
data2 <- OlinkAnalyze::read_NPX("~/NPX_file2_location.xlsx")
```  

To demonstrate how bridging works, we will use the example datasets
(`npx_data1` and `npx_data2`) from **OlinkAnalyze** package.

## Check bridging datasets

Explore and have an overview of the datasets that are going to be bridged. For 
example, plot and compare NPX distribution between datasets.

```{r check, message=FALSE}
# Load datasets
npx_1 <- OlinkAnalyze::npx_data1 %>% 
  dplyr::filter(!stringr::str_detect(string  = SampleID,
                                     pattern = 'CONTROL_SAMPLE')) %>% #Remove control samples
  dplyr::mutate(dataset = "data1")

npx_2 <- OlinkAnalyze::npx_data2 %>% 
  dplyr::filter(!stringr::str_detect(string = SampleID,
                                     pattern = 'CONTROL_SAMPLE')) %>% #Remove control samples
  dplyr::mutate(dataset = "data2")

# Plot NPX density before bridging normalization
dplyr::bind_rows(npx_1, npx_2) %>% 
  dplyr::mutate(Panel = stringr::str_replace(string      = Panel,
                                             pattern     = "Olink ",
                                             replacement = "")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = NPX, fill = Panel)) +
  ggplot2::geom_density(scale = 1, alpha = 0.7) + 
  ggplot2::facet_grid(dataset ~ Panel) +
  OlinkAnalyze::olink_fill_discrete(coloroption = c('teal', 'lightblue')) +
  OlinkAnalyze::set_plot_theme() + 
  ggplot2::ggtitle("Before bridging normalization: NPX distribution") +
  ggplot2::theme(axis.title.x    = ggplot2::element_blank(),
                 axis.title.y    = ggplot2::element_blank(),
                 strip.text      = ggplot2::element_text(size = 16),
                 legend.title    = ggplot2::element_blank(),
                 legend.position = "none")
```

Use PCA plot to visualize sample-to-sample distance before bridging.

```{r pca1, message=FALSE, fig.cap="PCA plot of combined datasets before bridging"}
## before bridging

### Generate unique SampleIDs
npx_1 <- OlinkAnalyze::npx_data1 %>% 
  dplyr::mutate(dataset  = "data1",
                SampleID = paste0(dataset, PlateID, SampleID))

npx_2 <- OlinkAnalyze::npx_data2 %>% 
  dplyr::mutate(dataset  = "data2",
                SampleID = paste0(dataset, PlateID, SampleID))

### PCA plot
dplyr::bind_rows(npx_1, npx_2) %>%
  OlinkAnalyze::olink_pca_plot(df          = .,
                               color_g     = "dataset", 
                               byPanel     = TRUE, 
                               coloroption = c('orange', 'darkblue')) 
```

## Perform bridging between two data sets

We can use `olink_normalization()` function to bridge two datasets. The bridging 
procedure is to first calculate **the median of the paired NPX differences** per
assay between the bridging samples as adjustment factor then use these adjustment 
factors to adjust NPX values between two datasets. The output from 
`olink_normalization()` function is a NPX table with adjusted NPX value in the 
column `NPX`.

```{r bridging, message=FALSE}
# Find overlapping samples
npx_1 <- OlinkAnalyze::npx_data1 %>% 
  dplyr::mutate(dataset = "data1") %>% 
  dplyr::filter(!stringr::str_detect(string  = SampleID,
                                     pattern = 'CONTROL_SAMPLE'))

npx_2 <- OlinkAnalyze::npx_data2 %>% 
  dplyr::mutate(dataset = "data2") %>% 
  dplyr::filter(!stringr::str_detect(string  = SampleID,
                                     pattern = 'CONTROL_SAMPLE'))

overlap_samples <- intersect(npx_1$SampleID, npx_2$SampleID)

# Perform Bridging normalization
npx_br_data <- OlinkAnalyze::olink_normalization(df1                     = npx_1, 
                                                 df2                     = npx_2, 
                                                 overlapping_samples_df1 = overlap_samples,
                                                 df1_project_nr          = '20200001',
                                                 df2_project_nr          = '20200002',
                                                 reference_project       = '20200001')

dplyr::glimpse(npx_br_data)
```

## Perform evaluation of bridging normalization

First, check NPX distribution in datasets after bridging normalization.

```{r densitybr, message=FALSE}
# Plot NPX density after bridging normalization
npx_br_data %>% 
  dplyr::mutate(Panel = stringr::str_replace(string      = Panel,
                                             pattern     = "Olink ",
                                             replacement = "")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = NPX, fill = Panel)) +
  ggplot2::geom_density(scale = 1, alpha = 0.7) + 
  ggplot2::facet_grid(dataset ~ Panel) +
  OlinkAnalyze::olink_fill_discrete(coloroption = c('teal', 'lightblue')) +
  OlinkAnalyze::set_plot_theme() + 
  ggplot2::ggtitle("After bridging normalization: NPX distribution") +
  ggplot2::theme(axis.title.x    = ggplot2::element_blank(),
                 axis.title.y    = ggplot2::element_blank(),
                 strip.text      = ggplot2::element_text(size = 16),
                 legend.title    = ggplot2::element_blank(),
                 legend.position = "none")
``` 

Then summarize number of assays that have adjustment factors in certain ranges.

```{r tbl_adj_fct, message=FALSE}
breaks <- c(-Inf, -1, -0.25, 0.25, 1, Inf)
labels <- c("(< -1]", "(-1,-0.25]", "(-0.25,0.25]", "(0.25,1]", "(> 1)")

reference_project <- '20200001' # reference project defined in bridging normalization

npx_br_data %>% 
  dplyr::mutate(Panel = stringr::str_replace(Panel, "Olink ", "")) %>% 
  dplyr::filter(Project != reference_project) %>% 
  dplyr::mutate(group = cut(x      = Adj_factor,
                            breaks = breaks,
                            labels = labels)) %>% 
  dplyr::select(OlinkID, Adj_factor, Panel, group) %>% 
  dplyr::distinct() %>% 
  dplyr::group_by(Panel, group) %>%
  dplyr::tally() %>% 
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = group, values_from = n) %>% 
  tibble::column_to_rownames(var = "Panel") %>% 
  dplyr::relocate(dplyr::any_of(labels)) %>% 
  kableExtra::kbl(booktabs = TRUE,
                  digits   = 2,
                  caption  = "Distribution of assays in different ranges of adjustment factors") %>%
  kableExtra::kable_styling(bootstrap_options = "striped",
                            full_width        = FALSE,
                            position          = "center",
                            latex_options     = "HOLD_position")
``` 

Finally, use PCA plot to check whether bridging normalization has effect in correcting batch effects.

```{r pca2, message=FALSE, fig.cap="PCA plot of combined datasets after bridging"}
## After bridging

### PCA plot
npx_br_data %>% 
  dplyr::mutate(SampleID = paste0(dataset, PlateID, SampleID)) %>%
  OlinkAnalyze::olink_pca_plot(df          = .,
                               color_g     = "dataset",
                               byPanel     = TRUE,
                               coloroption = c('orange', 'darkblue')) 
```
