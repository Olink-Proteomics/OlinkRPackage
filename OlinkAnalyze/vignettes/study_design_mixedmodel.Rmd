---
title: "A Guide to Comparative Analysis of longitudinal data across multiple groups"
author: "Olink DS team"
date: "`r Sys.Date()`"
output: 
  html_vignette:
    latex_engine: xelatex
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Olink® Analyze Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
--- 

```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>")
options(tibble.print_min = 4L, tibble.print_max = 4L)
library(dplyr)
library(ggplot2)
library(stringr)
library(OlinkAnalyze)


df <- OlinkAnalyze::npx_data1 %>% 
  filter(!str_detect(SampleID, 'CONTROL'))
df_QC <- OlinkAnalyze::npx_data1 %>% 
  filter(!str_detect(SampleID, 'CONTROL'))

```

# Introduction  

This vignette is designed to assist users working with longitudinal samples divided across multiple groups using linear mixed models. This guide aims to provide you with a comprehensive overview of the steps involved in analyzing Olink data when the samples are measured over time in different groups using the Olink R package. An example can be samples measured over time where half the subjects have been revived a treatment and the other half have not. 

By following this guide, you will gain a solid understanding of how to effectively compare and contrast groups, detect differences, and ultimately derive valuable conclusions from your data. Example code will be shown in this vignette, however it is still recommended to read the documentation for each function as not all options will be covered here. This can be done with the _help_ command.

```{r, eval=FALSE}
help("functionName")
```

If you don't have any longitudinal samples with multiple groups see our other study design vignettes. 

# Installation 

You can install Olink® Analyze from CRAN which is needed for the following walkthrough.

```{r, eval=FALSE}
install.packages("OlinkAnalyze")
```

After installing the package, the package needs to be loaded. Several packages from the tidyverse suite of packages are also used throughout this vignette, such as dplyr and stringr. Each individual package can be loaded using the _library_ function (`library("package")`) or the entire tidyverse suite of packages can be loaded as shown below.

```{r, eval=FALSE}
library(OlinkAnalyze)
library(tidyverse)
```

# Study overview

This vignette will help you if you have Olink data and are unsure on how to compare your longitudinal samples spread across multiple groups.  The Olink data file shouldn't be tempered with before loading it into R, as that may cause the data to not be recognized and loaded by the `read_NPX` function. Using the read_NPX function will always give you your data in a long format, where each row represent one sample and one protein. To load in your data in R use the following code:

```{r message=FALSE, eval=FALSE}
data <- read_NPX("~/NPX_file_location.csv")
# Argument should be the location of your NPX data. Data are usually in parquet, csv, xlsx or zip format depending on the product.
```  

An example of the first five row can be seen below in **Table 1**. Note that not all NPX files contain all of the selected columns shown below.

```{r message=FALSE, eval=T, echo=FALSE}
 df  %>% 
  select(SampleID, OlinkID, UniProt, Assay, MissingFreq, QC_Warning, NPX, LOD) %>% 
  head(5) %>% 
  knitr::kable(format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 1.** Example of data after being read in with read_NPX. Some columns have been left out due to space.",
               label = "manifest")
``` 

A sample manifest is also needed for the analysis. The sample manifest should included at least 4 columns, one with the sample name (matching the SampleID column in the NPX file) and at least two group information columns(for example a time and a treatment variable) and a subject column. An example of a sample manifest first 5 rows can are shown in **Table 2**.

```{r message=FALSE, eval=T, echo=FALSE}
df |> 
  select(SampleID, Treatment, Time, Subject) %>% 
  head(5)  %>% 
  knitr::kable(format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 2.** Sample manifest.",
               label = "manifest")
```  

When your manifest is created (usually before in excel or similar program) you can import it via the _Import dataset_ button in Rstudio or using a function like `read_excel` to import the file. 

```{r message=FALSE, eval=FALSE}
manifest <- readxl::read_excel("~/Manifest_file_location.xlsx")
```  

When both Olink NPX data and sample manifest are imported into R the can be combine using the following code:

```{r message=FALSE, eval=FALSE}
df_QC <- data %>% 
  left_join(manifest, by = SubjectID) %>% 
   filter(!str_detect(SampleID, 'CONTROL')) #removing Olinks control samples for downstream analysis
```  


# Quality control 

Before performing any statistical test on the data, it is good to inspect the data for potential outliers. Outliers can skew the results greatly and unless there is a reason to believe that they represent valid data points, it's generally best to handle them to avoid misleading conclusions. In this vignette, we will provide a brief overview of how to assess the data for outliers. For a more in depth view of outliers, check out our [Outlier Exclusion Vignette](https://cran.r-project.org/web/packages/OlinkAnalyze/vignettes/OutlierExclusion.html). 

Outliers can be spotted by graphing an overview of the entire dataset. This can be done looking at the sample distribution or a dimension reduction technique such as principal component analysis (PCA). Samples which appears to be outliers should be further assessed and may need to be removed from the downstream analysis. 

### Sample distribution

Looking at the sample distribution can be done using Olink Analyze `olink_dist_plot`. In **Figure 1**, all samples seem to have the same distribution. We see that one sample didn't pass Olink's Internal QC control. QC warnings do not necessarily need to be removed, but it can be good to take a closer look at these samples. 

If any samples have a completely different distribution, such as much lower/higher mean and/or much smaller/larger standard deviation, it may be necessary to remove that sample from downstream analysis.  

```{r, echo = F}
fcap1 <- "**Figure 1.** Box and Whisker Plot of Sample Distributions, colored by QC Warning."
fcap2 <- "**Figure 2.** Principal component analysis of samples, colored by QC Warning."
fcap3 <- "**Figure 3.** Boxplots of the top 6 significant proteins."
```

```{r message=FALSE,fig.cap=fcap1,fig.height = 4, fig.width = 8, fig.align = "center"}
df_QC %>% 
  filter(Panel == 'Olink Cardiometabolic') %>% # for illustration purpose we only plot one panel
  olink_dist_plot() +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, size = 5)) # when having multiple samples it can help to rotated them for readability
```  

### Principal component analysis

Global differences between samples can also be viewed using a PCA plot. A PCA plot of the data can be generated using Olink Analyze `olink_pca_plot` can be seen in **Figure 2**. Any samples which deviates a lot from the other samples could be considered outliers. 

```{r message=FALSE,fig.cap=fcap2, fig.height = 6, fig.width = 6, fig.align = "center"}
df_QC %>% 
   olink_pca_plot()
# the olink_pca_plot can show outliers by setting outlierDefX, outlierDefY 
```  

These plots can be used to determine whether there are any outlier and if it is right to remove these potential outliers and samples which don't pass Olinks internal QC control. These samples can be removed with the following code.

```{r message=FALSE, eval=FALSE}
df <- df_QC %>% 
  filter(QC_Warning == 'Pass') %>% # only included samples which pass QC. This is standard for Olink but if samples are few or paired there can be an argument to still included them. 
  filter(!(SampleID %in% c(NA))) # swap NA to the samples which was outliers, for example c('A1','A16') to remove sample with the name A1 and A16.

```  

Sometime including outlier or samples which don't pass QC can still be reasonable, especially in cases with very few samples.

# Analysis 
## Linear mixed model

Linear mixed model (LMM) is used to analyze data that have both fixed effects and random effects. It is particularly useful when dealing with data that exhibit hierarchical or nested structures or repeated measures. LMM extends the concept of a simple linear regression model to account for these complexities.

In an LMM, the "linear" aspect refers to the fact that the relationships between the dependent variable and the independent variables are assumed to be linear. The "mixed" aspect refers to the inclusion of both fixed effects and random effects in the model.


Here we will use the example data provided within Olink Analyze to assess differences between groups using the Treatment and Time variable. Six distinct groups, Treated and Untreated in 3 timepoints exist in this data, as shown below.

```{r message=FALSE, eval=T}
df %>%  
  select(SampleID, Treatment, Time, Subject) %>% 
  unique() %>%
  select(Treatment, Time) %>% 
  table

```  

LMM assesses the null hypothesis that no significant effect of the independent variables on the dependent variable. If the p-value associated with the test is lower than a predetermined significance level (typically 0.05), we can reject the null hypothesis and infer a significant effect of at least one independent variable on the dependent variable. This indicates that the independent variables, included in the model, have a statistically significant impact on explaining the variation in the dependent variable.
Conversely, if the p-value exceeds the significance level, we do not have enough evidence to reject the null hypothesis, suggesting an absence of a statistically significant effect of the independent variables on the dependent variable in the context of the linear mixed model.

The LMM also take into account the random effect, which is a critical component of the model. Random effects are used to model the variability within groups or clusters in the data, accounting for correlations and hierarchical structures that might exist. These random effects are essential in capturing the dependencies and correlations in the data that cannot be explained solely by the independent variables. The random effect are usually subject for Olink studies. 

Furthermore, it is crucial to address the issue of multiple testing when performing a LMM on multiple proteins simultaneously. Conducting multiple tests without appropriate adjustments can lead to an increased likelihood of false positive results. The tests in OlinkAnalyze always adjust for each protein tested. 

To perform the LMM use the OlinkAnalyze function *olink_lmer*. If the adjusted p-value are below 0.05 the function will also write that out as a significant. In **Table 3**, for the assay CCL18, UniProt P55774, there is a significant result in the Time term from the LMM. However just from the LMM test we can't conduct how the time term differ in that protein. To conduct which groups differ from which groups a post hoc test is needed. 

```{r message=FALSE, eval=T}
lmer_results <- olink_lmer(df = df, # specify your data
            variable = c("Time", 'Treatment'), # specify your variable, usually 1-2 
            random = "Subject") # specify your random effect 

```  

```{r message=FALSE, eval=T, echo=FALSE}
lmer_results %>% head(5)  %>% 
  select(Assay, OlinkID, UniProt, Panel, term, p.value, Adjusted_pval, Threshold) %>% 
  knitr::kable(format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 3.** LMM results of the 5 most significant proteins adn terms. Some coloumns have been left out due to space.",
               label = "manifest")
```  

# Post hoc LMM test

Following a LMM test, a post hoc test is usually performed on proteins and terms that show a significant result in the LMM. The post hoc test compares all groups against all other groups, showing which group differ from another. Each comparison will have a estimate and a adjusted p-value. 

```{r message=FALSE, eval=T}
#the post hoc test should only be performed on proteins which have a significant result in the ANOVA
significant_proteins_Time <- lmer_results %>% 
  filter(Threshold == 'Significant') %>% 
  filter(term == 'Time') %>% 
  pull(OlinkID)


lmer_posthoc_results_Time<-olink_lmer_posthoc(df,
                    olinkid_list = significant_proteins_Time, #significant proteins
                    variable=c("Time", 'Treatment'),
                    effect = 'Time',
                    random = 'Subject')

```  

The *olink_lmer_posthoc* function arrange the results based on adjusted p-value. For example in **Table 4**  on the first row the assay CCL18 have a significant difference between Baseline and week.6 of 2.67 NPX. One posthoc test should be for each significant assay in said term.  

```{r message=FALSE, eval=T, echo=FALSE}
lmer_posthoc_results_Time %>%
  head(5)  %>% 
  select(Assay, OlinkID, UniProt, Panel, contrast ,estimate, Adjusted_pval, Threshold) %>% 
  knitr::kable(format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 4.** ANOVA post hoc results of the 5 most significant contrasts and proteins. Some coloumns have been left out due to space.",
               label = "manifest")
```  


## Plots

To illustrate the results from a LMM a point range plot are a common way. These visualizations provide valuable insights into the differences between the groups and help in understanding the significance and effect sizes of the observed effects.

To illustrate the point range plot the *olink_lmer_plot* function can be used. In the example below only the top 6 significant proteins are plotted. 

```{r message=FALSE, eval=T, fig.height = 4, fig.width = 8, fig.align = "center"}
top6Significant_time<-lmer_results %>% 
  filter(Threshold == 'Significant') %>% 
  filter(term == 'Time') %>% 
  head(6) %>%   # just the top 6 for visualization
  pull(OlinkID) # pull out the OlinkID which is needed in olink_boxplot

lmer_top6_time<-olink_lmer_plot(df = df,
              variable=c("Time", 'Treatment'),
              random = 'Subject',
              x_axis_variable = 'Time',
              col_variable = 'Treatment',
              olinkid_list = top6Significant_time) 

lmer_top6_time
``` 

# Saving results

Having the results saved in csv files (or other format) and the plots in pdf (or other format) can making the results easier to work with, especially if the results are being shared with other people that do not have access to R. 

The following code can be used to save the results as a csv file.

```{r message=FALSE, eval=F}

write.table(lmer_results,
            paste0('LMER_Results.csv'),
            sep=';',row.names = F, quote = F)

write.table(lmer_posthoc_results_Time, # each term should be saved
            paste0('LMER_posthoc_Time_Results.csv'),
            sep=';',row.names = F, quote = F)

```  
