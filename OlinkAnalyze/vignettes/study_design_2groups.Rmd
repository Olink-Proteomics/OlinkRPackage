---
title: "A Guide to Comparative Analysis of Two Groups with Olink Data"
author: "Olink DS team"
date: "`r Sys.Date()`"
output: 
  html_vignette:
    latex_engine: xelatex
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{A Guide to Comparative Analysis of Two Groups with Olink Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
--- 

```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>")
options(tibble.print_min = 4L, tibble.print_max = 4L)
library(dplyr)
library(stringr)
library(ggplot2)
library(OlinkAnalyze)

df <- OlinkAnalyze::npx_data1 %>% 
  filter(!str_detect(SampleID, 'CONTROL'))
df_QC <- OlinkAnalyze::npx_data1 %>% 
  filter(!str_detect(SampleID, 'CONTROL'))


```

# Introduction  

This vignette is designed to assist users working with two distinct groups using t-test. This guide aims to provide you with a comprehensive overview of the steps involved in analyzing and comparing data from two groups in Olink data using Olink's R package, Olink Analyze. These two groups can encompass a variety of categories, such as healthy and diseased individuals, two different types of a condition, or male and female subjects. The objective of the analysis is to identify the differing proteins between the two groups.

By following this guide, you will gain a solid understanding of how to effectively compare and contrast two groups, detect differences, and ultimately derive valuable conclusions from your data. Example code will be shown in this vignette, however it is still recommended to read the documentation for each function as not all options will be covered here. This can be done with the _help_ command.

```{r, eval=FALSE}
help("functionName")
```

If you have more that two groups in your data, or a longitudinal study, see our other study design vignettes. 

# Installation 

You can install OlinkÂ® Analyze from CRAN which is needed for the following walkthrough.

```{r, eval=FALSE}
install.packages("OlinkAnalyze")
```

After installing the package, the package needs to be loaded. Several packages from the tidyverse suite of packages are also used throughout this vignette, such as dplyr and stringr. Each individual package can be loaded using the _library_ function (`library("package")`) or the entire tidyverse suite of packages can be loaded as shown below.

```{r, eval=FALSE}
library(OlinkAnalyze)
library(tidyverse)
```

# Study overview

This vignette will help you if you have Olink data and are unsure on how to compare your two groups. The Olink data file shouldn't be tempered with before loading it into R, as that may cause the data to not be recognized and loaded by the `read_NPX` function. Using the read_NPX function will always give you your data in a long format, where each row represent one sample and one protein. To load in your data in R, use the following code:

```{r message=FALSE, eval=FALSE}
data <- read_NPX("~/NPX_file_location.csv")
# Argument should be the location of your NPX data. Data are usually in parquet, csv, xlsx or zip format depending on the product.
```  

An example of the first five rows can be seen below in **Table 1**. Note that not all NPX files contain all of the selected columns shown below.

```{r message=FALSE, eval=T, echo=FALSE, warning=F}
df_subset <- df  %>% 
  select(SampleID, OlinkID, UniProt, Assay, MissingFreq, QC_Warning, NPX, LOD) %>% 
  head(5) 

  knitr::kable(df_subset,
               format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 1.** Example of data after being read in with read_NPX. Some columns have been left out due to space.",
               label = "exampleNPX",
               escape = F)
```  

A sample manifest is also needed for the analysis. The sample manifest should included at least 2 columns, one with the sample name (matching the SampleID column in the NPX file) and a second column with the group information for each sample as shown in **Table 2**.

```{r message=FALSE, eval=T, echo=FALSE}
df |> 
  select(SampleID, Treatment) %>% 
  head(5)  %>% 
  knitr::kable(format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 2.** Sample manifest.",
               label = "manifest")
```  

When your manifest is created (usually before in excel or similar program) you can import it via the _Import dataset_ button in RStudio or using a function like `read_excel` to import the file. 

```{r message=FALSE, eval=FALSE}
manifest <- readxl::read_excel("~/Manifest_file_location.xlsx")
```  

Once both Olink NPX data and sample manifest are imported into R, they can be combined using the following code:

```{r message=FALSE, eval=FALSE}
df_QC <- data %>% 
  left_join(manifest, 
            by = SubjectID) %>% 
   filter(!str_detect(SampleID, 'CONTROL')) #removing Olink control samples for downstream analysis
```  


# Quality control 

Before performing any statistical test on the data, it is good to inspect the data for potential outliers. Outliers can skew the results greatly and unless there is a reason to believe that they represent valid data points, it's generally best to handle them to avoid misleading conclusions. In this vignette, we will provide a brief overview of how to assess the data for outliers. For a more in depth view of outliers, check out our [Outlier Exclusion Vignette](https://cran.r-project.org/web/packages/OlinkAnalyze/vignettes/OutlierExclusion.html). 

Outliers can be spotted by graphing an overview of the entire dataset. This can be done looking at the sample distribution or a dimension reduction technique such as principal component analysis (PCA). Samples which appears to be outliers should be further assessed and may need to be removed from the downstream analysis. 

### Sample distribution

Looking at the sample distribution can be done using Olink Analyze `olink_dist_plot`. In **Figure 1**, all samples seem to have the same distribution. We see that one sample didn't pass Olink's Internal QC control. QC warnings do not necessarily need to be removed, but it can be good to take a closer look at these samples. 

If any samples have a completely different distribution, such as much lower/higher mean and/or much smaller/larger standard deviation, it may be necessary to remove that sample from downstream analysis.  
```{r, echo = F}
fcap1 <- "**Figure 1.** Box and Whisker Plot of Sample Distributions, colored by QC Warning."
fcap2 <- "**Figure 2.** Principal component analysis of samples, colored by QC Warning."
fcap3 <- "**Figure 3.** Boxplots of the top 6 significant proteins."
fcap4 <- "**Figure 4.** Volcano plot illustrating the p-value and estimate relationship."
fcap5 <- "**Figure 5.** Volcano plot illustrating the p-value and estimate relationship. Handful of proteins labeled selected."
```

```{r, dist_plot, fig.cap=fcap1, message=FALSE,fig.height = 4, fig.width = 8, fig.align = "center"}
df_QC %>% 
  filter(Panel == 'Olink Cardiometabolic') %>% # for illustration purpose we only plot one panel
  olink_dist_plot() +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, size = 5)) # when having multiple samples it can help to rotated the sample name for readability
```  

### Principal component analysis

Global differences between samples can also be viewed using a PCA plot. A PCA plot of the data can be generated using Olink Analyze `olink_pca_plot` can be seen in **Figure 2**. Any samples which deviates a lot from the other samples could be considered outliers. 


```{r message=FALSE,fig.cap=fcap2, fig.height = 6, fig.width = 6, fig.align = "center"}
df_QC %>% 
   olink_pca_plot()
# the olink_pca_plot can show outliers by setting outlierDefX, outlierDefY 
```  

These plots can be used to determine whether there are any outlier and if it is right to remove these potential outliers and samples which don't pass Olinks internal QC control. These samples can be removed with the following code.

```{r message=FALSE, eval=FALSE}
df <- df_QC %>% 
  filter(QC_Warning == 'Pass') %>% # only included samples which pass QC. This is standard for Olink but if samples are few or paired there can be an argument to still included them.
  filter(!(SampleID %in% c(NA))) # change NA to the samples which was outliers, 
  # for example c('A1','A16') to remove sample with the name A1 and A16.

```  

Sometimes including outlier or samples which don't pass QC can still be reasonable, especially in cases with very few samples or when samples are paired. 

# Analysis 
## T-test 

When comparing two groups, the most straightforward way is to perform a Welch's 2-sample t-test to see if there are any differences between the groups. This test allows us to use statistics to determine if there are any assays where the mean NPX value in 1 group is significant different from the mean NPX value in the other group.

Here we will use the example data provided within Olink Analyze to assess differences between groups using the Treatment variable. Two distinct groups, Treated and Untreated exist in this data, as shown below. 

```{r message=FALSE, eval=T}
df %>% 
  select(SampleID,Treatment) %>% 
  unique() %>% 
  select(Treatment) %>% 
  table()

```  

A t-test assesses the null hypothesis that there is no difference between the means of the two groups. If the p-value associated with the test is below a predetermined significance level (commonly 0.05), we reject the null hypothesis and conclude that there is a significant difference between the groups. On the other hand, if the p-value is above the significance level, we fail to reject the null hypothesis, indicating that there is insufficient evidence to suggest a significant difference.

Furthermore, it is crucial to address the issue of multiple testing when performing a t-test on multiple proteins simultaneously. Conducting multiple tests without appropriate adjustments can lead to an increased likelihood of false positive results. The tests in Olink Analyze adjust for each protein tested by default.

To perform a t-test, use the Olink Analyze function `olink_ttest`. If the adjusted p-value (listed in the column `Adjusted_pval`) is below 0.05, then the assay will also be listed as "Significant" in the `Threshold` column. For example, for the assay TRAIL (UniProt ID P50591) there is a significant difference in protein levels between the treated and untreated samples (**Table 3**). 

```{r message=FALSE, eval=T}
# Performing the t-test
t_test_results <- olink_ttest(df = df, # specify your data
            variable = 'Treatment') # specify your variable 

```  

```{r message=FALSE, eval=T, echo=FALSE}
t_test_results %>% head(5)  %>% 
  select(Assay, OlinkID, UniProt, Panel, estimate, p.value, Adjusted_pval, Threshold) %>% 
  knitr::kable(format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 3.** T-test results of the 5 most significant proteins. Some coloumns have been left out due to space.",
               label = "ttest_results")
```  

## Paired t-test

When dealing with paired samples, such as samples collected from the same individual at different time points, the paired t-test becomes a suitable choice. This statistical test takes into consideration that the measurements are related because they come from the same patient at different times. This consideration enhances the statistical power of the test.

To utilize the paired t-test, an additional column is required in the sample manifest, which signifies the pairing of the samples. An illustrative example is provided in **Table 4**.

```{r message=FALSE, eval=T, echo=FALSE}

df %>%
  filter(Time %in% c("Baseline","Week.6")) %>%
  select(SampleID, Time, Subject) %>% 
  head(6)  %>% 
  knitr::kable(format = "html",
               booktabs = T,
               linesep = "",
               digits = 4,
               longtable = T,
               row.names = F,
               caption = "**Table 4.** Sample manifest for when data is paired.",
               label = "manifest")
```

The procedure for performing a paired t-test follows a structure similar to that of a standard t-test. The olink_ttest function from Olink Analyze is employed in the same manner. In cases where the adjusted p-value (available in the Adjusted_pval column) falls below 0.05, the assay is marked as "Significant" in the Threshold column.

```{r message=FALSE, eval=F}
# Performing the paired t-test
paried_t_test_results <- olink_ttest(df = df, # specify your data
            variable = 'Time', # specify your variable 
            pair_id = 'Subject') # indicates the paired sample identifier

```  

### Visualization of Results

Two common ways to illustrate the results from a t-test are with boxplots and a volcano plot. These visualizations provide valuable insights into the differences between the two groups and help in understanding the significance and effect sizes of the observed effects.

The volcano plot is a powerful visualization that combines both statistical significance and effect size information in a single plot. In a volcano plot, each data point represents a variable or feature being tested (e.g. proteins). The x-axis represents the effect size (e.g., difference in means), while the y-axis represents the statistical significance (e.g., -log10(p-value)) associated with the t-test. 

#### Boxplots

To generate boxplots the `olink_boxplot` function can be used. The thick black  horizontal line within each box indicates the median, the colored area - the interquartile range, the ends of the vertical middle line represent the minimum and the maximum values, and the black dots indicate potential assay outliers (beyond the minumum or maximum valuses). Boxplots of the top 6 significant proteins are plotted in **Figure 3**. 

```{r boxplots, message=FALSE, eval=T}
top6Significant<-t_test_results %>% 
  filter(Threshold == 'Significant') %>% # only filter out the significant proteins
  head(6) %>%   # just the top 6 for visualization
  pull(OlinkID) # pull out the OlinkID which is needed in olink_boxplot

boxplot_top6<-olink_boxplot(df = df,
              variable = 'Treatment',
              olinkid_list = top6Significant)

``` 

```{r fig.cap = fcap3,  echo = T, message=T, eval=T, fig.height = 4, fig.width = 8,fig.align = "center" }
boxplot_top6[[1]]
```

#### Volcano Plot

The following code can be used to generate a volcano plot, seen in **Figure 4**. The x-axis
shows the mean difference between the two groups, and y-axis shows the -log10(p-value) using the nominal (unadjusted) p-value. By default, all significant proteins (after multiple testing adjustment) are plotted in red. The assays above the dashed line have a nominal p-value below 0.05. 

```{r fig.cap = fcap4, message=FALSE, eval=T, fig.height = 4, fig.width = 8, fig.align = "center"}
olink_volcano_plot(t_test_results)
``` 

The `olinkid_list` argument can be used to label specific assays. Below in **Figure 5** are an example when only proteins with an adjusted p-value of below 0.005 and 2 other proteins are included (IL4 and IL6). 

```{r fig.cap = fcap5, message=FALSE, eval=T, fig.height = 4, fig.width = 8, fig.align = "center"}

assays_to_included_byPvalue <- t_test_results %>%
  filter(Adjusted_pval < 0.005) %>% 
  pull(OlinkID)

assays_to_included_CustomSelected <- t_test_results %>%
  filter(Assay %in% c('IL4','IL6')) %>%
  pull(OlinkID)

assay_to_included <- c(assays_to_included_byPvalue,
                       assays_to_included_CustomSelected)

olink_volcano_plot(t_test_results, olinkid_list = assay_to_included)
``` 

# Saving results

Having the results saved in csv files (or other format) and the plots in pdf (or other format) can making the results easier to work with, especially if the results are being shared with other people that do not have access to R. 

The following code can be used to save the results as a csv file.

```{r message=FALSE, eval=F}

write.table(x = t_test_results,
            file = paste0('TtestResults.csv'),
            sep=';',
            row.names = F, 
            quote = F)

```  

The following code can be used to save every boxplot in a separate folder (in this case a in a folder called TtestBoxplot).

```{r message=FALSE, eval=F}

dir.create('TtestBoxplot') # create a folder 

for (i in ttest_results %>% 
     filter(Threshold == 'Significant') %>% # only saving the significant proteins
     pull(OlinkID)) {
  
  temp_name<- df_norm %>% # Saving the assay name for convenience
    filter(OlinkID == i) %>% 
    pull(Assay) %>% 
    unique()
    
  if(str_detect(temp_name,'/')){ # Replacing / with - in the assay name
    temp_name <-str_replace(temp_name,pattern = '/',replacement = '-')
  }
  
  temp_boxplot<-olink_boxplot(df = df , 
                               olinkid_list = i, 
                               variable = 'Status')
  
  # saving the assay and olinkID name as the plotname
  ggsave(paste0("TtestBoxplot/",i,"_",temp_name,".pdf"), 
         temp_boxplot[[1]],
         width = 8,
         height = 6)
  
}


``` 

 
# Contact Us!

We are always happy to help. Email us with any questions:

-   biostat\@olink.com for statistical services and general stats questions

-   biostattools\@olink.com for Olink Analyze and Shiny app support

-   support\@olink.com for Olink lab product and technical support

-   info\@olink.com for more information

